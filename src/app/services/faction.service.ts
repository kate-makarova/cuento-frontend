import { Injectable, signal, inject, effect } from '@angular/core';
import { ApiService } from './api.service';
import { Faction } from '../models/Faction';
import { Observable } from 'rxjs';

@Injectable({ providedIn: 'root' })
export class FactionService {
  private apiService = inject(ApiService);

  currentFactionId = signal<number>(0);
  currentFactionChildren = signal<Faction[]>([]);
  factionsSignal = signal<Faction[]>([]);
  readonly factions = this.factionsSignal.asReadonly();

  constructor() {
    effect(() => {
      const parentId = this.currentFactionId();
      this.loadFactionChildren(parentId);
    });
  }

  getFactionChildren(id: number): Observable<Faction[]> {
    return this.apiService.get<Faction[]>(`faction-children/${id}/get`);
  }

  loadFactionChildren(id: number): void {
    this.getFactionChildren(id).subscribe({
      next: (data) => {
        this.currentFactionChildren.set(data);
      },
      error: (err) => {
        console.error('Failed to load faction children', err);
        this.currentFactionChildren.set([]);
      }
    });
  }

  setCurrentFaction(id: number) {
    this.currentFactionId.set(id);
  }

  loadFactions(): void {
    this.apiService.get<Faction[]>('factions/get').subscribe({
      next: (data) => {
        this.factionsSignal.set(data);
      },
      error: (err) => {
        console.error('Failed to load factions', err);
      }
    })
  }
}
